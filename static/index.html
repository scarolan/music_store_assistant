<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algorhythm Music Store</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom scrollbar for chat */
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: #1f2937; }
        .chat-messages::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        
        /* Slide-in animation */
        .chat-panel { transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        .chat-panel.open { transform: translateX(0); }
        
        /* Typing indicator */
        .typing-dot { animation: typing 1.4s infinite both; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }
        
        /* Gradient text */
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    
    <!-- Navigation -->
    <nav class="bg-gray-800 border-b border-gray-700 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center space-x-3">
                    <div class="text-3xl">üéµ</div>
                    <span class="text-xl font-bold gradient-text">Algorhythm</span>
                </div>
                <div class="hidden md:flex items-center space-x-8">
                    <a href="#" class="text-gray-300 hover:text-white transition">Browse</a>
                    <a href="#" class="text-gray-300 hover:text-white transition">New Releases</a>
                    <a href="#" class="text-gray-300 hover:text-white transition">Genres</a>
                    <a href="#" class="text-gray-300 hover:text-white transition">My Account</a>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="text-gray-300 hover:text-white">
                        <i class="fas fa-search text-lg"></i>
                    </button>
                    <button class="text-gray-300 hover:text-white">
                        <i class="fas fa-shopping-cart text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="relative bg-gradient-to-br from-purple-900 via-gray-900 to-gray-900 py-20">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <h1 class="text-5xl md:text-6xl font-bold mb-6">
                    Discover Your <span class="gradient-text">Sound</span>
                </h1>
                <p class="text-xl text-gray-400 mb-8 max-w-2xl mx-auto">
                    Millions of tracks from legendary artists. Stream, download, and explore the world's largest digital music catalog.
                </p>
                <div class="flex justify-center space-x-4">
                    <button class="bg-purple-600 hover:bg-purple-700 px-8 py-3 rounded-full font-semibold transition">
                        Start Listening
                    </button>
                    <button class="border border-gray-600 hover:border-gray-400 px-8 py-3 rounded-full font-semibold transition">
                        Browse Catalog
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Featured Albums -->
    <section class="py-16 bg-gray-900">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold mb-8">Featured Albums</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-6">
                <!-- Album Cards -->
                <div class="group cursor-pointer">
                    <div class="aspect-square bg-gradient-to-br from-red-600 to-yellow-600 rounded-lg mb-3 flex items-center justify-center shadow-lg group-hover:shadow-xl transition">
                        <span class="text-4xl">‚ö°</span>
                    </div>
                    <h3 class="font-semibold truncate">Back in Black</h3>
                    <p class="text-gray-400 text-sm">AC/DC</p>
                </div>
                <div class="group cursor-pointer">
                    <div class="aspect-square bg-gradient-to-br from-blue-600 to-purple-600 rounded-lg mb-3 flex items-center justify-center shadow-lg group-hover:shadow-xl transition">
                        <span class="text-4xl">üé∏</span>
                    </div>
                    <h3 class="font-semibold truncate">Led Zeppelin IV</h3>
                    <p class="text-gray-400 text-sm">Led Zeppelin</p>
                </div>
                <div class="group cursor-pointer">
                    <div class="aspect-square bg-gradient-to-br from-orange-600 to-red-600 rounded-lg mb-3 flex items-center justify-center shadow-lg group-hover:shadow-xl transition">
                        <span class="text-4xl">üåÖ</span>
                    </div>
                    <h3 class="font-semibold truncate">The Joshua Tree</h3>
                    <p class="text-gray-400 text-sm">U2</p>
                </div>
                <div class="group cursor-pointer">
                    <div class="aspect-square bg-gradient-to-br from-pink-600 to-purple-600 rounded-lg mb-3 flex items-center justify-center shadow-lg group-hover:shadow-xl transition">
                        <span class="text-4xl">ü§ò</span>
                    </div>
                    <h3 class="font-semibold truncate">Master of Puppets</h3>
                    <p class="text-gray-400 text-sm">Metallica</p>
                </div>
                <div class="group cursor-pointer">
                    <div class="aspect-square bg-gradient-to-br from-gray-700 to-gray-900 rounded-lg mb-3 flex items-center justify-center shadow-lg group-hover:shadow-xl transition">
                        <span class="text-4xl">üñ§</span>
                    </div>
                    <h3 class="font-semibold truncate">Back to Black</h3>
                    <p class="text-gray-400 text-sm">Amy Winehouse</p>
                </div>
                <div class="group cursor-pointer">
                    <div class="aspect-square bg-gradient-to-br from-green-600 to-teal-600 rounded-lg mb-3 flex items-center justify-center shadow-lg group-hover:shadow-xl transition">
                        <span class="text-4xl">‚ò†Ô∏è</span>
                    </div>
                    <h3 class="font-semibold truncate">Number of the Beast</h3>
                    <p class="text-gray-400 text-sm">Iron Maiden</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Customer Info Banner (simulating logged-in state) -->
    <section class="bg-gray-800 border-y border-gray-700 py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center">
                        <span class="font-bold">FH</span>
                    </div>
                    <div>
                        <p class="font-semibold">Welcome back, Frank!</p>
                        <p class="text-sm text-gray-400">Customer #16 ‚Ä¢ fharris@google.com</p>
                    </div>
                </div>
                <div class="text-sm text-gray-400">
                    <span class="mr-4">üéµ 12 purchases</span>
                    <span>üí≥ Last order: Nov 15, 2025</span>
                </div>
            </div>
        </div>
    </section>

    <!-- More Content -->
    <section class="py-16 bg-gray-900">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h2 class="text-3xl font-bold mb-8">Top Artists</h2>
            <div class="flex space-x-8 overflow-x-auto pb-4">
                <div class="flex-shrink-0 text-center">
                    <div class="w-24 h-24 bg-gradient-to-br from-red-500 to-orange-500 rounded-full mb-2"></div>
                    <p class="font-semibold">AC/DC</p>
                </div>
                <div class="flex-shrink-0 text-center">
                    <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full mb-2"></div>
                    <p class="font-semibold">Led Zeppelin</p>
                </div>
                <div class="flex-shrink-0 text-center">
                    <div class="w-24 h-24 bg-gradient-to-br from-green-500 to-teal-500 rounded-full mb-2"></div>
                    <p class="font-semibold">U2</p>
                </div>
                <div class="flex-shrink-0 text-center">
                    <div class="w-24 h-24 bg-gradient-to-br from-yellow-500 to-red-500 rounded-full mb-2"></div>
                    <p class="font-semibold">Metallica</p>
                </div>
                <div class="flex-shrink-0 text-center">
                    <div class="w-24 h-24 bg-gradient-to-br from-pink-500 to-purple-500 rounded-full mb-2"></div>
                    <p class="font-semibold">Deep Purple</p>
                </div>
                <div class="flex-shrink-0 text-center">
                    <div class="w-24 h-24 bg-gradient-to-br from-indigo-500 to-blue-500 rounded-full mb-2"></div>
                    <p class="font-semibold">Iron Maiden</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Chat Toggle Button -->
    <button id="chatToggle" class="fixed bottom-6 right-6 w-16 h-16 bg-purple-600 hover:bg-purple-700 rounded-full shadow-lg flex items-center justify-center z-50 transition-all hover:scale-110">
        <i class="fas fa-comments text-2xl"></i>
    </button>

    <!-- Chat Panel -->
    <div id="chatPanel" class="chat-panel fixed top-0 right-0 h-full w-full md:w-96 bg-gray-800 shadow-2xl z-50 flex flex-col">
        <!-- Chat Header -->
        <div class="bg-gray-900 p-4 flex items-center justify-between border-b border-gray-700">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-headset text-lg"></i>
                </div>
                <div>
                    <h3 class="font-semibold">Support Assistant</h3>
                    <p class="text-xs text-green-400">‚óè Online</p>
                </div>
            </div>
            <button id="chatClose" class="text-gray-400 hover:text-white p-2">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="chat-messages flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Welcome message -->
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-sm"></i>
                </div>
                <div class="bg-gray-700 rounded-lg rounded-tl-none p-3 max-w-[80%]">
                    <p>Hi Frank! üëã I'm the Algorhythm support assistant. I can help you with:</p>
                    <ul class="mt-2 text-sm text-gray-300 space-y-1">
                        <li>üéµ Finding music & albums</li>
                        <li>üìã Viewing your invoices</li>
                        <li>üí≥ Processing refunds</li>
                        <li>üë§ Account information</li>
                    </ul>
                    <p class="mt-2">How can I help you today?</p>
                </div>
            </div>
        </div>

        <!-- HITL Waiting Panel (shown when waiting for supervisor) -->
        <div id="waitingPanel" class="hidden bg-yellow-900/50 border-t border-yellow-600 p-4">
            <div class="flex items-center space-x-3">
                <div class="animate-spin w-5 h-5 border-2 border-yellow-400 border-t-transparent rounded-full"></div>
                <div>
                    <span class="font-semibold text-yellow-400">Waiting for Supervisor Approval</span>
                    <p class="text-sm text-gray-300">Your request has been sent to a supervisor for review...</p>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="p-4 border-t border-gray-700">
            <form id="chatForm" class="flex space-x-3">
                <input 
                    type="text" 
                    id="chatInput" 
                    placeholder="Type your message..." 
                    class="flex-1 bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-purple-500 transition"
                >
                <button type="submit" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <!-- Overlay for mobile -->
    <div id="chatOverlay" class="hidden fixed inset-0 bg-black/50 z-40 md:hidden"></div>

    <script>
        // State
        let threadId = null;
        let pendingApproval = false;
        let pollInterval = null;

        // Elements
        const chatToggle = document.getElementById('chatToggle');
        const chatPanel = document.getElementById('chatPanel');
        const chatClose = document.getElementById('chatClose');
        const chatOverlay = document.getElementById('chatOverlay');
        const chatForm = document.getElementById('chatForm');
        const chatInput = document.getElementById('chatInput');
        const chatMessages = document.getElementById('chatMessages');
        const waitingPanel = document.getElementById('waitingPanel');

        // Toggle chat panel
        function toggleChat() {
            chatPanel.classList.toggle('open');
            chatOverlay.classList.toggle('hidden');
            if (chatPanel.classList.contains('open')) {
                chatInput.focus();
            }
        }

        chatToggle.addEventListener('click', toggleChat);
        chatClose.addEventListener('click', toggleChat);
        chatOverlay.addEventListener('click', toggleChat);

        // Add message to chat
        function addMessage(content, isUser = false, isSystem = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex items-start space-x-3 ${isUser ? 'flex-row-reverse space-x-reverse' : ''}`;
            
            const avatar = isUser 
                ? '<div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0"><span class="text-sm font-bold">FH</span></div>'
                : '<div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center flex-shrink-0"><i class="fas fa-robot text-sm"></i></div>';
            
            const bubbleClass = isUser 
                ? 'bg-blue-600 rounded-lg rounded-tr-none' 
                : isSystem 
                    ? 'bg-yellow-900/50 border border-yellow-600 rounded-lg rounded-tl-none'
                    : 'bg-gray-700 rounded-lg rounded-tl-none';
            
            // Convert markdown-style bold to HTML
            const formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            messageDiv.innerHTML = `
                ${avatar}
                <div class="${bubbleClass} p-3 max-w-[80%]">
                    <p>${formattedContent}</p>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Show typing indicator
        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex items-start space-x-3';
            typingDiv.innerHTML = `
                <div class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-sm"></i>
                </div>
                <div class="bg-gray-700 rounded-lg rounded-tl-none p-3">
                    <div class="flex space-x-1">
                        <div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div>
                        <div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div>
                        <div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTyping() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Poll for approval status
        function startPolling() {
            if (pollInterval) return;
            
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/status/${threadId}?customer_id=16`);
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        // Approval was processed!
                        stopPolling();
                        waitingPanel.classList.add('hidden');
                        pendingApproval = false;
                        chatInput.disabled = false;
                        
                        // Show the result
                        addMessage(data.message);
                        
                        // Start a fresh thread for subsequent messages
                        // This avoids issues with stale graph state after rejection
                        threadId = null;
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 2000); // Poll every 2 seconds
        }

        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // Send message to backend
        async function sendMessage(message) {
            addMessage(message, true);
            showTyping();
            chatInput.disabled = true;

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        thread_id: threadId,
                        customer_id: 16
                    })
                });

                const data = await response.json();
                hideTyping();
                
                threadId = data.thread_id;
                
                if (data.requires_approval) {
                    pendingApproval = true;
                    addMessage(data.response, false, true);
                    waitingPanel.classList.remove('hidden');
                    chatInput.disabled = true;
                    // Start polling for approval status
                    startPolling();
                } else {
                    addMessage(data.response);
                    chatInput.disabled = false;
                }
            } catch (error) {
                hideTyping();
                addMessage('Sorry, there was an error connecting to the server. Please try again.', false, true);
                console.error('Error:', error);
                chatInput.disabled = false;
            }

            chatInput.focus();
        }

        // Event listeners
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = chatInput.value.trim();
            if (message && !pendingApproval) {
                chatInput.value = '';
                sendMessage(message);
            }
        });

        // Keyboard shortcut to open chat
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && chatPanel.classList.contains('open')) {
                toggleChat();
            }
        });
    </script>
</body>
</html>